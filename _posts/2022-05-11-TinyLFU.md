---
layout: post
title: "[è«–æ–‡è§£è®€][TinyLFU] A Highly Efficient Cache Admission Policy"
description: ""
category: 
- è«–æ–‡è§£è®€
tags: ["bloom filter"]

---

![image-20220504162659830](../images/2021/image-20220504162659830.png)

# ä»¥å‰çš„å•é¡Œ 

![What is Memory Hierarchy: Definition, Diagram, Architecture and Advantages](https://www.elprocus.com/wp-content/uploads/Memory-Hierarchy.jpg)

ä¸è«–æ˜¯è¨˜æ†¶é«”æˆ–æ˜¯ä»»ä½•è³‡æ–™å„²å­˜é«”ï¼ˆæˆ–æ˜¯å¤§å®¶å¸¸ç”¨çš„ Redisï¼‰ï¼Œéƒ½æœƒä½¿ç”¨ Cache ä¾†å­˜æ”¾çŸ­æœŸæœƒåè¦†ä½¿ç”¨åˆ°çš„è³‡æ–™ã€‚ å› ç‚º cache å…·æœ‰è®€å–å¿«é€Ÿï¼Œä½†æ˜¯å®¹é‡ç›¸å°å°ï¼ˆä¸”åƒ¹æ ¼è¼ƒè²´ï¼‰ã€‚æ‰€ä»¥ç„¡æ³•å°‡åœ¨ Physical memory çš„è³‡æ–™å…¨éƒ¨å­˜ä¸Šï¼Œé€™æ™‚å€™å°±æ˜¯éœ€è¦æœ‰ Cache Replacement Policy (ä¹Ÿå°±æ˜¯ã€Œå¿«å–çš„å–ä»£ç­–ç•¥ã€)

ä¸€èˆ¬ä¾†èªªçš„åšæ³•æœ‰ä»¥ä¸‹å¹¾ç¨®ï¼š

- **FIFO (First-In First-Out):** é€éå…ˆé€²å…ˆå‡ºçš„æ–¹å¼ï¼Œå¾€å¾€é€™æ¨£å®¹æ˜“æœ‰ç›¸ç•¶å¤§çš„åŠŸè€—åœ¨æ–¼è³‡æ–™ä¸æ–·çš„æ›é€²ä¾†èˆ‡æ›å‡ºå»ã€‚
- **LRU(Least Recently Used)**: å–ä»£è³‡æ–™çš„æ™‚å€™ï¼Œæœƒå»é¸æ“‡è¿‘ä¾†æœ€ä¹…çš„ã€‚   (RecentlyUsed --)
- **LFU(Least Frequency Used):** å–ä»£è³‡æ–™çš„æ™‚å€™ï¼Œé¸æ“‡æœ€å°‘è¢«è®€å–åˆ°çš„ã€‚ (Read Count ++)

é‚£éº¼é€™äº›è½èµ·ä¾†å¥½åƒéƒ½æ²’æœ‰å•é¡Œï¼Œç‚ºä»€éº¼æœƒéœ€è¦æœ‰ **TinyLFU** ?

## ä»¥å‰æ¼”ç®—æ³•æœ‰ä»€éº¼å•é¡Œã€‚ï¼Ÿ

## LRU æœ‰ä»€éº¼å•é¡Œ? 
LRU(Least Recently Used)ï¼šæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ã€‚

å®ƒæ˜¯å„ªå…ˆæ·˜æ±°æ‰æœ€ä¹…æœªè¨ªå•åˆ°çš„æ•¸æ“šã€‚ç¼ºé»æ˜¯ä¸èƒ½å¾ˆå¥½åœ°æ‡‰å°å¶ç„¶çš„çªç™¼æµé‡ã€‚æ¯”å¦‚ä¸€å€‹æ•¸æ“šåœ¨ä¸€åˆ†é˜å…§çš„å‰59ç§’è¨ªå•å¾ˆå¤šæ¬¡ï¼Œè€Œåœ¨æœ€å¾Œ1ç§’æ²’æœ‰è¨ªå•ï¼Œä½†æ˜¯æœ‰ä¸€æ‰¹å†·é–€æ•¸æ“šåœ¨æœ€å¾Œä¸€ç§’é€²å…¥ç·©å­˜ï¼Œé‚£éº¼ç†±é»æ•¸æ“šå°±æœƒè¢«æ²–åˆ·æ‰ã€‚

## LFU æœ‰ä»€éº¼å•é¡Œï¼Ÿ

LFU(Least Frequently Used)ï¼š

æœ€è¿‘æœ€å°‘é »ç‡ä½¿ç”¨ã€‚å®ƒæ˜¯å„ªå…ˆæ·˜æ±°æ‰æœ€ä¸ç¶“å¸¸ä½¿ç”¨çš„æ•¸æ“šï¼Œéœ€è¦ç¶­è­·ä¸€å€‹è¡¨ç¤ºä½¿ç”¨é »ç‡çš„å­—æ®µã€‚

- **æ“ä½œ LFU æ™‚é–“è¤‡æŸ¥åº¦æ˜¯**ï¼š $$O(log(n))$$
- ç”±æ–¼å–ä»£æ–¹æ¡ˆå–ä»£æ–¹å¼æ˜¯æŒ‘é¸çŸ­æœŸï¼ˆå–æ±º cache å¤§å°ï¼‰ï¼Œä¾†æŒ‘é¸æœ€é•·ä½¿ç”¨çš„ã€‚ ä½†æ˜¯å¯èƒ½ç™¼ç”Ÿä¸€å€‹ç‹€æ³æ˜¯ï¼Œå¦‚æœæŸä»½è³‡æ–™çŸ­æœŸä¸å¸¸ä½¿ç”¨ï¼Œä½†æ˜¯é•·æœŸä¾†èªªä»–é »ç‡ç¢ºæ˜¯æœ€é«˜çš„ã€‚åè€Œé€™å€‹ç‹€æ³æœƒé€ æˆæ²’æœ‰æ•ˆç‡ã€‚

ä¸»è¦æœ‰å…©å€‹ç¼ºé»ï¼š

ä¸€ã€å¦‚æœè¨ªå•é »ç‡æ¯”è¼ƒé«˜çš„è©±ï¼Œé »ç‡å­—æ®µæœƒå æ“šä¸€å®šçš„ç©ºé–“ï¼›

äºŒã€ç„¡æ³•åˆç†æ›´æ–°æ–°ä¸Šçš„ç†±é»æ•¸æ“šï¼Œæ¯”å¦‚æŸå€‹æ­Œæ‰‹çš„è€æ­Œæ’­æ”¾æ­·å²è¼ƒå¤šï¼Œæ–°å‡ºçš„æ­Œå¦‚æœå’Œè€æ­Œä¸€èµ·æ’åºçš„è©±ï¼Œå°±æ°¸ç„¡å‡ºé ­ä¹‹æ—¥ã€‚


é‚£è¦å¦‚ä½•è§£æ±ºé€™äº›å•é¡Œå‘¢ï¼Ÿ

# ä»€éº¼æ˜¯ TinyLFU ? æ˜¯åšä»€éº¼ç”¨ï¼Ÿ

![image-20220504173929676](../images/2021/image-20220504173929676.png)

TinyLFU è§£æ±º LRU å’ŒLFUä¸Šè¿°çš„ç¼ºé»ã€‚W-TinyLFU ç®—æ³•ç”±è«–æ–‡ã€ŠTinyLFU: A Highly Efficient Cache Admission Policyã€‹æå‡ºã€‚

å®ƒä¸»è¦åšå…©ä»¶äº‹ï¼š

ä¸€ã€æ¡ç”¨ Countâ€“Min Sketch ç®—æ³•é™ä½é »ç‡ä¿¡æ¯å¸¶ä¾†çš„ç©ºé–“è€—æï¼›

äºŒã€ç¶­è­·ä¸€å€‹PKæ©Ÿåˆ¶ä¿éšœæ–°ä¸Šçš„ç†±é»æ•¸æ“šèƒ½å¤ ç·©å­˜ã€‚

Countâ€“Min Sketch ç®—æ³•é¡ä¼¼ Bloom filter æ€æƒ³ï¼Œå°æ–¼é »ç‡çµ±è¨ˆæˆ‘å€‘å…¶å¯¦ä¸éœ€è¦ä¸€å€‹ç²¾ç¢ºå€¼ã€‚å­˜å„²æ•¸æ“šæ™‚ï¼Œå°keyé€²è¡Œå¤šæ¬¡ hash å‡½æ•¸é‹ç®—å¾Œï¼ŒäºŒç¶­æ•¸çµ„ä¸åŒä½ç½®å­˜å„²é »ç‡ï¼ˆCaffeine å¯¦éš›å¯¦ç¾çš„æ™‚å€™æ˜¯ç”¨ä¸€ç¶­ long å‹æ•¸çµ„ï¼Œæ¯å€‹ long å‹æ•¸å­—åˆ‡åˆ†æˆ16ä»½ï¼Œæ¯ä»½4bitï¼Œé»˜èª15æ¬¡ç‚ºæœ€é«˜è¨ªå•é »ç‡ï¼Œæ¯å€‹keyå¯¦éš› hash ç­å››æ¬¡ï¼Œè½åœ¨ä¸åŒ long å‹æ•¸å­—çš„16ä»½ä¸­æŸå€‹ä½ç½®ï¼‰ã€‚è®€å–æŸå€‹keyçš„è¨ªå•æ¬¡æ•¸æ™‚ï¼Œæœƒæ¯”è¼ƒæ‰€æœ‰ä½ç½®ä¸Šçš„é »ç‡å€¼ï¼Œå–æœ€å°å€¼è¿”å›ã€‚å°æ–¼æ‰€æœ‰keyçš„è¨ªå•é »ç‡ä¹‹å’Œæœ‰å€‹æœ€å¤§å€¼ï¼Œç•¶é”åˆ°æœ€å¤§å€¼æ™‚ï¼Œæœƒé€²è¡Œresetå³å°å„å€‹ç·©å­˜keyçš„é »ç‡é™¤ä»¥2ã€‚

TinyLFUè—‰åŠ©äº†æ•¸æ“šæµSketchingæŠ€è¡“ï¼Œå®ƒå¯ä»¥ç”¨å°å¾—å¤šçš„ç©ºé–“å­˜æ”¾é »æ¬¡ä¿¡æ¯ã€‚TinyLFUæ¡ç”¨äº†ä¸€ç¨®åŸºæ–¼æ»‘å‹•çª—å£çš„ `æ™‚é–“è¡°æ¸›è¨­è¨ˆæ©Ÿåˆ¶` ï¼Œè—‰åŠ©æ–¼ä¸€ç¨®ç°¡æ˜“çš„ reset æ“ä½œï¼šæ¯æ¬¡æ·»åŠ ä¸€æ¢è¨˜éŒ„åˆ°Sketchçš„æ™‚å€™ï¼Œéƒ½æœƒçµ¦ä¸€å€‹è¨ˆæ•¸å™¨ä¸ŠåŠ  1ï¼Œç•¶è¨ˆæ•¸å™¨é”åˆ°ä¸€å€‹å°ºå¯¸ W çš„æ™‚å€™ï¼ŒæŠŠæ‰€æœ‰è¨˜éŒ„çš„ Sketch æ•¸å€¼éƒ½é™¤ä»¥ 2ï¼Œè©² reset æ“ä½œå¯ä»¥èµ·åˆ°è¡°æ¸›çš„ä½œç”¨ ã€‚




## Sample Code

https://github.com/dgryski/go-tinylfu

é€™é‚Šç¨å¾®åˆ—å‡ºç›¸é—œç¨‹å¼ç¢¼ï¼š 

[https://github.com/dgryski/go-tinylfu/blob/fba88f4a7f91124e5cc36723834506b20b5bae80/tinylfu.go](https://github.com/dgryski/go-tinylfu/blob/fba88f4a7f91124e5cc36723834506b20b5bae80/tinylfu.go)





## Paper: [https://arxiv.org/abs/1512.00727](https://arxiv.org/abs/1512.00727)

```
TinyLFU: A Highly Efficient Cache Admission Policy

Gil Einziger, Roy Friedman, Ben Manes

This paper proposes to use a frequency based cache admission policy in order to boost the effectiveness of caches subject to skewed access distributions. Given a newly accessed item and an eviction candidate from the cache, our scheme decides, based on the recent access history, whether it is worth admitting the new item into the cache at the expense of the eviction candidate.
Realizing this concept is enabled through a novel approximate LFU structure called TinyLFU, which maintains an approximate representation of the access frequency of a large sample of recently accessed items. TinyLFU is very compact and light-weight as it builds upon Bloom filter theory.
We study the properties of TinyLFU through simulations of both synthetic workloads as well as multiple real traces from several sources. These simulations demonstrate the performance boost obtained by enhancing various replacement policies with the TinyLFU eviction policy. Also, a new combined replacement and eviction policy scheme nicknamed W-TinyLFU is presented. W-TinyLFU is demonstrated to obtain equal or better hit-ratios than other state of the art replacement policies on these traces. It is the only scheme to obtain such good results on all traces.
```



# Redis æœ‰å“ªä¸€äº› Cache Replacement Policy ?

åƒè€ƒï¼š [93é¢è©¦å¸¸å•ï¼šRedis è¨˜æ†¶é«”æ»¿äº†æ€éº¼è¾¦ï¼Ÿ](https://iter01.com/557774.html)

å¯¦éš›ä¸ŠRediså®šç¾©äº†å¹¾ç¨®ç­–ç•¥ç”¨ä¾†è™•ç†é€™ç¨®æƒ…æ³ï¼š

- **noeviction(é è¨­ç­–ç•¥)**ï¼šå°æ–¼å¯«è«‹æ±‚ä¸å†æä¾›æœå‹™ï¼Œç›´æ¥è¿”å›éŒ¯èª¤ï¼ˆDELè«‹æ±‚å’Œéƒ¨åˆ†ç‰¹æ®Šè«‹æ±‚é™¤å¤–ï¼‰
- **allkeys-lru**ï¼šå¾æ‰€æœ‰keyä¸­ä½¿ç”¨LRUæ¼”ç®—æ³•é€²è¡Œæ·˜æ±°
- **volatile-lru**ï¼šå¾è¨­å®šäº†éæœŸæ™‚é–“çš„keyä¸­ä½¿ç”¨LRUæ¼”ç®—æ³•é€²è¡Œæ·˜æ±°
- **allkeys-random**ï¼šå¾æ‰€æœ‰keyä¸­éš¨æ©Ÿæ·˜æ±°è³‡æ–™
- **volatile-random**ï¼šå¾è¨­å®šäº†éæœŸæ™‚é–“çš„keyä¸­éš¨æ©Ÿæ·˜æ±°
- **volatile-ttl**ï¼šåœ¨è¨­å®šäº†éæœŸæ™‚é–“çš„keyä¸­ï¼Œæ ¹æ“škeyçš„éæœŸæ™‚é–“é€²è¡Œæ·˜æ±°ï¼Œè¶Šæ—©éæœŸçš„è¶Šå„ªå…ˆè¢«æ·˜æ±°


# Reference

- [LRU and LFU Cache Algorithms](https://xuri.me/2016/08/13/lru-and-lfu-cache-algorithms.html)

- [W-TinyLFUè®ºæ–‡é˜…è¯»ä¸åŸç†åˆ†æâ€‹](https://www.modb.pro/db/218970)

- [é˜…è¯» redis æºç ï¼Œå­¦ä¹ ç¼“å­˜æ·˜æ±°ç®—æ³• W-TinyLFU](https://mytechshares.com/2021/11/07/redis-known-lru-wtinylfu/)

- [[è®ºæ–‡ã€ŠTinyLFU: A Highly Ecient Cache Admission Policyã€‹é˜…è¯»ç¬”è®°](https://segmentfault.com/a/1190000016091569)](https://segmentfault.com/a/1190000016091569)

-  [93é¢è©¦å¸¸å•ï¼šRedis è¨˜æ†¶é«”æ»¿äº†æ€éº¼è¾¦ï¼Ÿ](https://iter01.com/557774.html)

- [dgryski](https://github.com/dgryski)/**[go-tinylfu](https://github.com/dgryski/go-tinylfu)**
